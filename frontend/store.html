<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookstore - Shop</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f8f8f8; }
        header { background: #8d31f5; color: #fff; padding: 20px 0; text-align: center; }
        nav { background: #541998; padding: 10px 0; text-align: center; }
        nav a { color: #fff; margin: 0 15px; text-decoration: none; font-weight: bold; }
        .container { max-width: 1000px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .search-bar { margin-bottom: 30px; }
        .search-bar input { width: 60%; padding: 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; }
        .book-list { display: flex; flex-wrap: wrap; gap: 24px; }
        .book-card { background: #fafafa; border: 1px solid #eee; border-radius: 6px; width: 220px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); display: flex; flex-direction: column; align-items: center; }
        .book-card img { width: 120px; height: 180px; object-fit: cover; margin-bottom: 12px; border-radius: 4px; }
        .book-title { font-size: 1.1em; font-weight: bold; margin-bottom: 6px; text-align: center; }
        .book-author { color: #555; font-size: 0.95em; margin-bottom: 8px; }
        .book-price { color: #2d3e50; font-weight: bold; margin-bottom: 10px; }
        .add-cart-btn { background: #8d31f5; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background 0.2s; margin-bottom: 8px; }
        .add-cart-btn:hover { background: #541998; }
        .add-cart-btn:disabled { background: #ccc; color: #666; cursor: not-allowed; }
        .add-cart-btn:disabled:hover { background: #ccc; }
        .buy-now-btn { background: #28a745; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background 0.2s; font-weight: bold; }
        .buy-now-btn:hover { background: #218838; }
        .buy-now-btn:disabled { background: #ccc; color: #666; cursor: not-allowed; }
        .buy-now-btn:disabled:hover { background: #ccc; }
        .button-group { display: flex; flex-direction: column; gap: 6px; width: 100%; }
        .book-card.out-of-stock { opacity: 0.7; }
        .stock-status { font-size: 0.9em; margin-bottom: 8px; font-weight: bold; }
        .stock-status.in-stock { color: #1a7f37; }
        .stock-status.out-of-stock { color: #d1242f; }
        .in-cart-msg { margin-top: 8px; color: #1a7f37; font-size: 0.9em; display: none; }
        .in-cart-msg.visible { display: block; }
    </style>
</head>
<body>
    <header>
        <h1>Welcome to The Bookstore</h1>
    </header>
    <nav>
        <a href="store.html">Home</a>
        <a href="about.html">About</a>
        <a href="order-history.html">My Orders</a>
        <a href="cart.html" id="cartLink">Cart (<span id="cartCount">0</span>)</a>
    
        <a href="#" onclick="logout()">Logout</a></nav>
    <div class="container">
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search for books by title, author, or ISBN">
        </div>
        <div class="book-list" id="bookList">
            <!-- Books loaded from backend will be inserted here -->
        </div>
    </div>
    <script>
        // Load API helper (served by Flask)
        const script = document.createElement('script');
        script.src = '/api.js';
        script.onload = () => initStore();
        document.body.appendChild(script);

        async function initStore() {
            const searchInput = document.getElementById('searchInput');
            const bookList = document.getElementById('bookList');
            const cartCount = document.getElementById('cartCount');
            // initialize cart from localStorage so cart.html can read it
            function getCart() { try { return JSON.parse(localStorage.getItem('cart') || '[]'); } catch (_) { return []; } }
            function setCart(c) { try { localStorage.setItem('cart', JSON.stringify(c || [])); } catch (_) {} }
            let cart = getCart();

            function updateCartCount() {
                cartCount.textContent = cart.length === 0 ? 'empty' : cart.length;
            }

            function createCard(book) {
                const card = document.createElement('div');
                card.className = 'book-card';
                const imgSrc = book.cover_url || `https://covers.openlibrary.org/b/isbn/${book.isbn}-L.jpg`;
                const title = book.title || 'Untitled';
                const author = book.author || 'Unknown';
                const price = (typeof book.price !== 'undefined') ? `$${parseFloat(book.price).toFixed(2)}` : '$0.00';
                const stockQuantity = book.stock_quantity || 0;
                const inStock = stockQuantity > 0;

                // Add out-of-stock class for styling
                if (!inStock) {
                    card.classList.add('out-of-stock');
                }

                card.innerHTML = `
                    <img src="${imgSrc}" alt="Book Cover">
                    <div class="book-title">${title}</div>
                    <div class="book-author">by ${author}</div>
                    <div class="book-price">${price}</div>
                    <div class="stock-status ${inStock ? 'in-stock' : 'out-of-stock'}">
                        ${inStock ? `in stock` : 'Out of Stock'}
                    </div>
                `;

                const btn = document.createElement('button');
                btn.className = 'add-cart-btn';
                btn.textContent = inStock ? 'Add to Cart' : 'Out of Stock';
                if (!inStock) btn.disabled = true;

                // Create Buy Now button
                const buyNowBtn = document.createElement('button');
                buyNowBtn.className = 'buy-now-btn';
                buyNowBtn.textContent = 'Buy Now';
                if (!inStock) buyNowBtn.disabled = true;

                // message element to show under the button when item is in cart
                const msg = document.createElement('div');
                msg.className = 'in-cart-msg';
                msg.textContent = 'Item in cart';

                function isInCart() {
                    const c = getCart();
                    if (book.id) return c.some(i => i.id === book.id);
                    return c.some(i => i.isbn && book.isbn && i.isbn === book.isbn);
                }

                function updateMsg() {
                    if (isInCart()) msg.classList.add('visible');
                    else msg.classList.remove('visible');
                }

                btn.addEventListener('click', () => {
                    if (!inStock) return;
                    // avoid duplicates: if item already exists, still push (simple behavior)
                    const item = { 
                        id: book.id, 
                        isbn: book.isbn, 
                        title, 
                        author, 
                        price: parseFloat(book.price) || 0  // Store numeric price value
                    };
                    cart.push(item);
                    setCart(cart); // persist
                    updateCartCount();
                    updateMsg();
                });

                // Buy Now button click handler
                buyNowBtn.addEventListener('click', () => {
                    if (!inStock) return;
                    
                    // Add item to cart first
                    const item = { 
                        id: book.id, 
                        isbn: book.isbn, 
                        title, 
                        author, 
                        price: parseFloat(book.price) || 0
                    };
                    
                    // Check if item is already in cart
                    const currentCart = getCart();
                    const existingItem = book.id ? 
                        currentCart.find(i => i.id === book.id) : 
                        currentCart.find(i => i.isbn && book.isbn && i.isbn === book.isbn);
                    
                    if (!existingItem) {
                        currentCart.push(item);
                        setCart(currentCart);
                        updateCartCount();
                    }
                    
                    // Redirect to checkout
                    window.location.href = 'cart.html';
                });

                // Create button group container
                const buttonGroup = document.createElement('div');
                buttonGroup.className = 'button-group';
                buttonGroup.appendChild(btn);
                buttonGroup.appendChild(buyNowBtn);

                card.appendChild(buttonGroup);
                card.appendChild(msg);
                // show initial state
                updateMsg();
                return card;
            }

            async function loadBooks() {
                try {
                    const res = await window.API.getBooks();
                    const books = (res && res.data) ? res.data : [];
                    bookList.innerHTML = '';
                    // Render all books, including those with 0 stock
                    books.forEach(b => bookList.appendChild(createCard(b)));
                } catch (err) {
                    console.error('Failed to load books:', err);
                    // Fallback: keep the page empty or show a message
                    bookList.innerHTML = '<p>Failed to load books.</p>';
                }
            }

            searchInput.addEventListener('input', function() {
                const filter = searchInput.value.toLowerCase();
                const cards = bookList.querySelectorAll('.book-card');
                cards.forEach(card => {
                    const title = card.querySelector('.book-title').textContent.toLowerCase();
                    const author = card.querySelector('.book-author').textContent.toLowerCase();
                    if (title.includes(filter) || author.includes(filter)) card.style.display = '';
                    else card.style.display = 'none';
                });
            });

            updateCartCount();
            loadBooks();
        }
    </script>
<script>
function logout() { try { localStorage.removeItem('jwt'); } catch(e) {} window.location.href = 'index.html'; }
</script>
</body>
</html>
